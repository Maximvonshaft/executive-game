# Practice Card Games — 全量实施路线图（阶段划分 & 交付清单）v1

> 目标：将“多游戏、PVP优先、移动端优先”的 Telegram Mini App 从 MVP 演进为可规模化运营的完整产品。此文档不含时间估算，按阶段递进；每个阶段都有**范围、契约/代码产物、验收标准、风险与缓解**。

---

## Phase 0 — 基线与合规（Foundations）
**范围**
- 代码仓库/CI/CD、环境变量与密钥管理；开发/预发/生产三套配置。
- Telegram WebApp 登录（initData HMAC 校验）与 JWT 会话。
- 移动端适配规范：断点、横竖屏、安全区（safe-area）、触控目标≥44px。
- 视觉主题与组件基线（黑金极简）；错误码字典与提示文案映射。

**契约/产物**
- `openapi.yaml`（Auth 基线）、`mobile-guidelines.md`、`error-codes.md`、`style-guide.md`。

**验收**
- 真机进入 Mini App 自动登录成功；横竖屏切换 UI 不错位；错误码→前端友好提示。

**风险/缓解**
- Bot Token 泄漏 → 秘钥轮换与只读权限；加密存储；密钥定期轮换流程。

---

## Phase 1 — PVP 垂直切片（五子棋闭环）
**范围**
- 大厅（最近/全部游戏 + 操作卡）→ 匹配/房间 → 五子棋对局 → 结果 → 回放读取。
- WebSocket 基线（心跳、断线重连、幂等等）；事件溯源日志。

**契约/产物**
- HTTP：`/api/games`、`/api/match/start|cancel`、`/api/rooms`、`/api/rooms/join`。
- WS：`join_room/ready/play_action/request_state/ping` ↔ `room_state/match_started/turn_started/action_applied/action_rejected/match_result/pong`。
- 引擎：`engine-gomoku.md` + 纯函数实现。
- E2E：两台真机脚本（匹配成功/取消、落子延迟、断线重连）。

**验收**
- 两端真机完成一局；断网 10s 恢复局面正确；落子→对手看到 ≤ 200ms（本地）。

**风险/缓解**
- WS 不稳 → 指数退避重连、`sinceSeq` 状态补齐、闸门限流。

---

## Phase 2 — 多游戏接入（斗地主 / 德州扑克 / 象棋 / 国际象棋）
**范围**
- 在 Phase 1 架构不变前提下，按“引擎适配器”快速接入多款游戏。
- 大厅游戏分类、搜索与“最近游玩”完善；房间人数/座位适配。

**契约/产物**
- 为每种游戏补充 `games/:id/meta`（人数、时限、开局参数）。
- 引擎文档：`engine-doudizhu.md`、`engine-texas.md`、`engine-cchess.md`、`engine-chess.md`。
- 对局 UI 骨架与资源（牌面/棋盘/动效）。

**验收**
- 每个游戏均可匹配、对战、结算、回放；切换游戏不影响其它玩法。

**风险/缓解**
- 规则复杂/边界多 → 先“训练版”规则（不涉及高级规则/禁手），逐步补完；
- 资源体积增长 → 首局懒加载、按需分包。

---

## Phase 3 — 排行 & 任务 & 资料卡（留存基础）
**范围**
- 段位/评分（Glicko2），7天/30天/总榜；用户资料卡与历史战绩。
- 每日任务/成就徽章；分享卡片（群内分享）。

**契约/产物**
- HTTP：`/api/leaderboard`、`/api/profile/:id`、`/api/tasks/today`、`/api/tasks/:id/claim`。
- 对局结束触发内部评分更新（异步）。

**验收**
- 完成一局→段位/榜单变化可见；任务可领奖；分享卡片渲染正常。

**风险/缓解**
- 刷分 → 评分区间移动平均 + 冷却；同IP/设备风控；异常行为回放复核。

---

## Phase 4 — 私密房 / 好友 / 观战（社交增强）
**范围**
- 私密房（邀请码/踢人/开局）、好友/最近对手、观战只读（限速、人数上限）。

**契约/产物**
- HTTP：`/api/rooms`、`/api/rooms/join`、`/api/friends`（轻量）。
- WS：观战频道/频率限制；房间权限模型。

**验收**
- 非成员无法出牌；观战延迟与带宽在阈值内；拉黑/举报流程打通。

**风险/缓解**
- 滥用观战 → 速率限制、延时队列、房主可关闭观战。

---

## Phase 5 — AI 陪练（可选，MVP 后）
**范围**
- 局面分析/建议：规则+启发式为主，LLM 仅做解释文本与复盘（成本可控）。
- 练习模式不计分；残局训练与教程。

**契约/产物**
- HTTP：`/api/ai/suggest`（可选，Phase 5 新增）。
- 缓存键：同构局面缓存；提示频率限制。

**验收**
- 同一复杂局面给出稳定建议；练习模式与 PVP 隔离明确。

**风险/缓解**
- 成本与延迟 → 小模型/缓存/限制；断路器降级回规则提示。

---

## Phase 6 — 反外挂 / 审计 / 观测（规模化）
**范围**
- 服务端权威判定与帧序校验、幂等键、异常指纹；
- 审计回放一键复原（事件哈希）；
- Observability：OpenTelemetry、日志/指标/追踪统一看板。

**契约/产物**
- 审计接口：`/internal/replay/:id` 只读；
- 指标埋点：匹配等待、WS p95、断线恢复、对局时长分布。

**验收**
- 指定对局可完整重演；异常操作可定位；SLO 稳定达标。

**风险/缓解**
- 高并发 → 单独的匹配/房间微服务（Go/Rust 可选）、Redis 有序集、热点分片。

---

## Phase 7 — 国际化 / 无障碍 / 运营后台
**范围**
- 多语言（至少中英）、RTL 兼容；基础无障碍（对比度、可读性）。
- 运营后台：封禁/解封、任务配置、活动 Banner、公告。

**契约/产物**
- i18n 资源文件（命名规则、一键导入导出）；
- 后台 HTTP：`/admin/tasks`、`/admin/banners`（权限控制）。

**验收**
- 语言切换不刷新页面；后台改配置能热更新到前台（开关系统）。

**风险/缓解**
- 文案分散 → 统一 i18n 管理；权限分层（只读/运营/管理员）。

---

## Phase 8 — 变现与生态（可选）
**范围**
- 皮肤/主题/表情包等装饰性付费（先虚拟货币再考虑真实支付）；
- 赛事体系（赛季制、积分换奖）。

**契约/产物**
- 支付/虚拟货币接口（如采用 Telegram Stars 等需符合平台与当地合规）；
- 赛季与活动配置接口。

**验收**
- 购买/退款/申诉路径完整；活动期间留存/活跃提升。

**风险/缓解**
- 合规高风险 → 先装饰性道具，不做涉赌/变相博彩；完善客服与 /paysupport 通路。

---

## 统一交付清单（每阶段追加/更新）
- `openapi.yaml`（HTTP 契约，版本化）
- `ws-contract.md`（事件/错误码/心跳/重连）
- `engine-spec/*.md`（各游戏引擎接口与规则）
- `mobile-guidelines.md`（断点/横竖屏/安全区/触控/动效/性能）
- `observability.md`（指标、日志、追踪、SLO）
- `security-and-anti-cheat.md`（权限/幂等/指纹/审计）
- `mock-runbook.md`（Mock 启动、脚本、切换真服务）
- `e2e-checklist.md`（真机用例套件）
- `risk-register.md`（风险清单与缓解策略）

---

## 验收矩阵（示例）
| 能力 | Phase 1 | Phase 2 | Phase 3 | Phase 4 | Phase 5 | Phase 6 |
|---|---|---|---|---|---|---|
| 登录与会话 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 多游戏 | ♟️五子棋 | + 斗地主/德扑/象棋/国际象棋 | 维持 | 维持 | 维持 | 维持 |
| PVP 实时 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 排行/任务 | – | – | ✅ | ✅ | ✅ | ✅ |
| 私密房/好友/观战 | – | – | – | ✅ | ✅ | ✅ |
| AI 陪练 | – | – | – | – | ✅ | ✅ |
| 反外挂/审计/观测 | 基线 | 基线 | 强化 | 强化 | 强化 | ✅ |

---

### 备注
- 上述阶段**可并行推进**，但 **Phase 1 必须优先完成**，否则实时基建和移动端体验无法验证。
- 任何“破坏性变更”必须通过契约版本（`v1` → `v2`）推进；客户端默认向后兼容。

