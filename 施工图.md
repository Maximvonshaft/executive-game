# Practice Card Games — 0-1 全量开发与交付蓝图

> 目标：以 React + Vite + TypeScript + Phaser 3 为核心技术栈，交付一套覆盖五子棋、象棋、斗地主、德州扑克的移动端优先智力棋牌游戏合集，实现从愿景定义、玩法规则、排位匹配、视觉素材到运维监控的端到端落地方案。本文件整合产品、设计、客户端、服务端、运维的详细要求，作为从 0-1 研发与迭代的唯一事实来源。

---

## 目录
1. [产品定位与范围](#产品定位与范围)
2. [组织架构与协作机制](#组织架构与协作机制)
3. [技术总览](#技术总览)
4. [前端实现蓝图（React × Phaser）](#前端实现蓝图react--phaser)
5. [视觉与交互规范](#视觉与交互规范)
6. [素材与资产产线](#素材与资产产线)
7. [音频与配乐设计](#音频与配乐设计)
8. [游戏玩法规则详解](#游戏玩法规则详解)
9. [排位、匹配与输赢规则](#排位匹配与输赢规则)
10. [经济体系与商业化](#经济体系与商业化)
11. [社交、反作弊与风控](#社交反作弊与风控)
12. [数据模型与事件追踪](#数据模型与事件追踪)
13. [开发流程与交付阶段](#开发流程与交付阶段)
14. [测试、验收与质量保障](#测试验收与质量保障)
15. [运维、发布与应急](#运维发布与应急)
16. [附录](#附录)

---

## 产品定位与范围
- **愿景**：打造移动端优先的公平竞技棋牌合集，为休闲玩家提供易上手体验，为进阶玩家提供稳定的排位体系和深度复盘能力。
- **目标用户**：
  - **休闲玩家**：碎片化时间、偏好单机/友局、重视主题皮肤。
  - **竞技玩家**：追求排位、公平性、历史数据与回放。
  - **社交玩家**：偏好邀请开房、观战、语音聊天与表情互动。
- **关键 KPI（V1）**：
  - 匹配成功率 ≥ 97%；对局完成率 ≥ 95%；逃跑率 ≤ 3%。
  - 断线重连成功率 ≥ 95%；客户端 p95 输入延迟 ≤ 100ms。
  - 首屏加载（本地） ≤ 1s，对局首屏（4G） ≤ 1.5s。
- **版本范围**：
  - **V1**：五子棋、象棋、斗地主（基础牌型）、德州扑克（6 人限注）。支持大厅、匹配、房间、排位、好友、断线重连、回放、商城皮肤、订阅、基础反作弊、埋点 AB、监控告警。
  - **V2**：斗地主全牌型与智能提示、德州锦标赛、跨区匹配、赛季榜单、观战延迟、Battle Pass、进阶反作弊、更多主题与音频降噪策略。
- **成功标准**：上线后 30 天内 DAU≥50k，D7 留存≥35%，用户评分≥4.5，主要运营指标和 SLO 达标。

---

## 组织架构与协作机制
- **RACI**：
  - 产品负责人（R）：指标达成、路线图、需求优先级。
  - 技术负责人（A）：架构守护、容量规划、技术债清单。
  - 前端负责人（R）：React/Phaser 集成、性能、无障碍、PWA。
  - 游戏程序（C）：Phaser 场景、动画时间线、命令处理。
  - 后端负责人（R）：服务边界、规则引擎、排位/匹配计算。
  - 美术总监（R）：视觉语言、素材产线、命名规范、导出模板。
  - 音频设计师（C）：响度校准、事件映射、压缩策略。
  - QA 负责人（R）：测试矩阵、自动化脚本、真机覆盖。
  - 运维/SRE（R）：CI/CD、监控告警、应急响应。
- **协作节奏**：双周迭代，周一需求评审、周三设计评审、周五联调同步；Figma + ZeroHeight 输出设计系统，Jira 管理 WBS，Notion 归档知识库。
- **接口管理**：所有 HTTP/WS 协议集中在 `openapi.yaml` 与 `asyncapi.yaml`；任何更改需发起 ADR。

---

## 技术总览
- **客户端**：React 18 + TypeScript + Vite，Phaser 3 承载对局渲染，Zustand + Immer 管理状态，i18n 使用 FormatJS，PWA（Service Worker + Web App Manifest），IndexedDB 存档。
- **服务端**：Node.js（NestJS + Fastify），WebSocket Gateway（房间/匹配），规则引擎（TypeScript/Go，可独立部署）。Redis 用于缓存与匹配队列，PostgreSQL 负责事务，NATS 作为事件流，ClickHouse 聚合分析。
- **运维**：Docker 镜像，K8s 部署，多副本网关（粘性会话），Prometheus + Grafana + Loki + Sentry 监控，全链路 TLS。
- **数据治理**：GDPR 合规，PII 分表加密，访问审计与脱敏备份。

---

## 前端实现蓝图（React × Phaser）
### 目录结构
```
src/
  app/              # 应用骨架、路由、布局、ErrorBoundary
  components/       # 通用 UI（按钮、表单、弹窗、HUD 面板、加载状态）
  features/
    lobby/          # 大厅首页、游戏卡片、活动位
    matchmaking/    # 匹配流程、排队动画、取消逻辑
    profile/        # 资料、历史战绩、成就
    store/          # 商城、订阅、结算页
    settings/       # 系统设置、无障碍、语言
    social/         # 好友、邀请、聊天
  games/            # 游戏插件目录
    gomoku/
      manifest.ts
      scenes/
      assets/       # 仅引用资源入口（真实资源走 CDN）
      ui/           # React HUD 组件
    cchess/
    doudizhu/
    texas/
  state/
    sessionStore.ts
    settingsStore.ts
    gameStore.ts
  services/
    httpClient.ts
    wsClient.ts
    matchmaking.ts
    replay.ts
  hooks/
    useGameBridge.ts
    useResponsive.ts
    useAccessibility.ts
  i18n/
    zh-CN.json
    en-US.json
  assets/
    fonts/
    icons/
    illustrations/
  workers/
    comboWorker.ts   # 牌型提示等高计算逻辑
  styles/
    themes/
    tokens.css.ts
  sw/
    service-worker.ts
```

### 核心模块
- **GameBridge**：轻量事件总线（mitt/自研），解耦 React UI 与 Phaser 场景。
- **Zustand Store 划分**：
  - `sessionStore`：账号、网络、WS 状态、令牌。
  - `settingsStore`：音量、主题、语言、无障碍偏好。
  - `gameStore`：当前房间状态、玩家信息、回放上下文。
- **Phaser 场景层级**：
  - `BootScene` → `PreloadScene` → `TableScene`（棋盘/桌面）→ `FxScene`（特效）→ `UiScene`（可选）。
  - 场景间通过事件与共享状态协调，逻辑帧固定 60fps。
- **渲染策略**：默认 WebGL，低端设备自动降级 Canvas；Scale.FIT + 1280×720 逻辑分辨率；DPR 上限 2.5。
- **PWA 能力**：Service Worker 预缓存 shell、常用游戏；Stale-While-Revalidate 策略；离线时提示“可进入单机模式”。
- **性能优化**：Vite 分块、路由级动态 import、TexturePacker atlas、音频懒加载、OffscreenCanvas 处理复杂计算、React 使用 Suspense + SWR 缓存。
- **无障碍实现**：
  - 组件层面提供 ARIA 属性、焦点管理、键盘导航。
  - 游戏事件同步到文本 HUD（例如“轮到你行动”文本提示）。
  - 支持高对比度与色盲模式，字体可调范围 80%–140%。

---

## 视觉与交互规范
### 设计哲学
- 融合“现代东方棋舍 + 轻奢纸牌桌”的视觉氛围，强调沉浸、可读性与公平感。
- 以“曜金”（深色金属质感）和“晨光”（明亮米金）为基础主题，衍生“极夜”（高对比夜间）与“节庆”（节日限定）。

### 色彩与字体
- **主色**：曜金主题（#1C1A23、#CBA265）、晨光主题（#F9F4E7、#8C5B2E）。
- **强调色**：胜利（金橙）、警告（琥珀）、错误（石榴红）、信息（海蓝）。
- **字体**：中文优先使用系统字体（苹方/思源黑体）、英文使用 Inter；标题字重 600，正文 400。
- **色盲模式**：采用蓝/紫/橙高对比组合，禁用红绿相近配色。

### 布局与组件
- **大厅**：卡片网格（两列移动端、一行一列小屏）、顶部活动横幅、快捷入口（单机、排行榜、商城）。
- **HUD**：统一横向信息条，左侧显示玩家状态与计时，右侧操作按钮；关键按钮 ≥ 56×56px。
- **弹窗**：模态层 90% 阈值透明，顶部标题栏、内容滚动、底部 CTA 区。
- **匹配动效**：圆形波纹 + 角色剪影；延时文本提示匹配范围扩张。
- **聊天与表情**：底部浮层、九宫格表情、常用快捷语句；支持语音转文本（V2）。

### 交互准则
- 手势优先点击/拖拽，避免长按；提供替代按钮。
- 切换主题即时应用，动画 ≤ 300ms。
- 提供“新手指引层”（高亮 + 文案 + 语音）。

---

## 素材与资产产线
### 分类与命名
- **文件结构**：
  - `/ui`（全局 UI 元素）
  - `/icons`（单色/双色 iconfont，24/32/48px）
  - `/cards`（牌面、筹码、卡背）
  - `/board`（棋盘纹理、棋子）
  - `/fx`（粒子、光效、胜利动画）
  - `/illustrations`（空状态、教程插画）
  - `/fonts`（自定义字形文件）
  - `/audio`（BGM、SFX、语音）
- **命名规则**：`{gameId}_{category}_{name}@{scale}.{ext}`，例：`doudizhu_card_spadeA@2x.png`、`gomoku_board_grid@1x.png`。
- **版本管理**：Git LFS 存储大体积资源，资源 manifest 与 CDN 哈希同步。

### 产线流程
1. 美术在 Figma/Blender 中建立主设计文档，按照主题导出组件。
2. 使用 TexturePacker 打包到 atlas（最大 2048×2048），输出 JSON + PNG。
3. 通过脚本生成 `assets-manifest.json`，包含版本、尺寸、哈希、用途。
4. 上传 CDN，Service Worker 根据 manifest 预缓存。

### 游戏专属素材
- **五子棋**：
  - 棋盘纹理：竹制、石板两套；棋子黑/白半透明高光。
  - 落子特效：微粒扩散、木纹震动。
  - 辅助线：可开启/关闭，色盲模式采用虚线。
- **象棋**：
  - 棋盘：宣纸底 + 红墨河界；暗色主题使用乌木纹理。
  - 棋子：传统篆体 + 金属质感，前后对比明显。
  - 行棋高亮：起点圆环 + 终点光晕；禁手提示红色闪烁。
- **斗地主**：
  - 牌面：A~2、大小王，整套 54 张；卡背三套（锦红、墨蓝、冰川）。
  - 手牌托盘：渐变木质/皮革质感；提示按钮、叫分按钮。
  - 炸弹/飞机特效：粒子爆裂、轨迹光线。
- **德州扑克**：
  - 桌面：椭圆皮革桌（曜金/晨光）、LED 边框。
  - 筹码：面额颜色区分（白/红/绿/黑/紫），2D+轻 3D 阴影。
  - 公共牌翻牌动画：翻牌 180°，带金属音效；胜利演出烟花。

### HUD 与系统素材
- 排行榜徽章、段位图标、赛季证章、奖励宝箱。
- 空状态插画：匹配失败、无好友、离线模式提示。
- 设置与控制面板 icon：音量、亮度、字幕、键盘、无障碍。

---

## 音频与配乐设计
- **总体响度**：-16 ± 2 LUFS，峰值不裁剪。
- **分轨**：
  - UI 点击、系统提示、错误警告、胜负演出。
  - 游戏专属：落子声、棋子碰撞、发牌声、筹码堆叠、倒计时滴答。
  - 语音播报：玩家回合提示、断线提醒、多语言支持，字幕同步。
  - 背景音乐：大厅（轻松爵士）、对局（低强度氛围）、结算（胜利/失败两套）。
- **格式**：优先 OGG/AAC；长度>10s 的循环音乐制作无缝 loop；低端机提供 HE-AAC。
- **性能**：同一时刻音轨≤8；低性能设备自动关闭混响/回声。
- **事件映射**：定义 `audio-map.json`，由场景读取，如 `gomoku.place_stone`、`texas.deal_flop`、`system.error`。

---

## 游戏玩法规则详解
### 公共约定
- **房间结构**：支持匹配房、好友房、单机/本机模式（AI 或热座）。
- **时间控制**：局时 + 步时（棋类），倒计时圆环展示；牌类提供行动倒计时与托管逻辑。
- **托管/逃跑**：玩家断线 30s 内保留，超时自动托管；托管逻辑遵循最保守策略（斗地主自动过牌/出最小合法牌，德州自动弃牌）。
- **回放**：记录动作序列、RNG 种子、关键帧；支持播放/暂停/倍速。

### 五子棋（Gomoku）
- **玩家人数**：2 人，黑先。
- **棋盘**：15×15，坐标 A-O / 1-15；可选禁手（长连、四四、三三）。
- **目标**：任意方向连续五子即胜；若启用禁手，禁手点判负。
- **流程**：
  1. 玩家准备，黑白分配。
  2. 轮流落子，点击交叉点；HUD 显示剩余步时（10s）与局时（5 分）。
  3. 形成五连则立即结束；局时耗尽或 3 次重复申请和棋可判和。
- **胜负**：连五胜、对方认输、超时判负；协商和棋需双方确认。
- **记分**：排位胜 +25 MMR、负 -25、和棋 ±5；禁手判负扣额外 5 分。

### 中国象棋（CChess）
- **玩家人数**：2 人，红方先行。
- **棋盘**：9×10，含楚河汉界。
- **棋子与走法**：帅、仕、相、车、马、炮、兵；遵循传统规则。
- **流程**：
  1. 开局自动布局；双方确认局时（8 分）和步时（10s）。
  2. 玩家轮流移动棋子，走法高亮、可行位置光点提示。
  3. 三次重复局面自动提示和棋；可申请和棋或悔棋（非排位）。
- **胜负**：将死、对方认输、超时、无子可走判负；三次重复、50 回合未吃子判和。
- **记分**：胜 +28、负 -28、和 ±6；超时/弃权扣额外 10 分。

### 斗地主（基础牌型）
- **玩家人数**：3 人，随机地主；支持好友房自选。
- **牌组**：一副 54 张牌。
- **阶段**：
  1. **发牌**：每人 17 张，3 张底牌。
  2. **叫分/抢地主**：按顺序叫 1-3 分或不叫；最高分者当地主，底牌归地主。
  3. **出牌**：地主先出；需出同类型更大牌或选择过牌。
- **牌型**：单、对、三张、三带一、顺子（5-12 连）、连对（3 组以上）、飞机、炸弹；王炸最大。
- **胜负**：任一方出完手牌即胜；若农民一人出完，双方共胜。
- **超时策略**：
  - 叫分阶段超时自动“不叫”。
  - 出牌阶段超时自动出最小合法牌（地主）或过牌（农民）。
- **记分**：
  - 基础分 × 倍数（炸弹/春天/王炸）× 叫分值。
  - 排位分 = 胜负得分 × 权重（地主 1.2，农民 1.0）。
  - 逃跑扣当局最大倍数 × 2，MMR 额外 -35。

### 德州扑克（6 人限注）
- **玩家人数**：2-6 人，限注（Limit Hold'em）。
- **筹码**：默认买入 100BB；小盲/大盲自动扣除。
- **阶段**：
  1. Pre-Flop：玩家获 2 张底牌，按顺时针行动（跟注/加注/弃牌）。
  2. Flop：翻三张公共牌；行动从小盲后玩家开始。
  3. Turn：翻第四张；下注额度提升。
  4. River：翻第五张；最后一轮下注。
  5. Showdown：未弃牌玩家亮牌，最大牌型获胜。
- **牌型比较**：皇家同花顺 > 同花顺 > 四条 > 葫芦 > 同花 > 顺子 > 三条 > 两对 > 一对 > 高牌。
- **胜负**：
  - 摊牌牌力高者赢取底池；平手分池。
  - 所有人弃牌则最后行动玩家直接获胜。
- **超时**：行动倒计时 20s，5s 内震动提示；超时自动弃牌。
- **记分**：排位根据盈利 BB 数折算成 MMR（胜方 +10~+40，负方 -10~-40），逃跑视为弃牌并扣额外 -25。

---

## 排位、匹配与输赢规则
### 排位体系（Glicko-2）
- **参数**：初始 µ=1500、φ=350、σ=0.06；每局按对局结果、对手等级计算新 µ/φ。
- **段位映射**：
  - 青铜（<1450）、白银（1450-1599）、黄金（1600-1749）、铂金（1750-1899）、钻石（1900-2049）、大师（2050-2199）、王者（≥2200）。
  - 每段位 5 星，星数 = (µ - 下限) / (段位跨度/5)。
- **衰减与保护**：
  - 14 天未参赛 φ ×1.1，最高至 350。
  - 连败保护：连续 3 败后扣分减半；连胜奖励 +10%。
- **赛季**：12 周为一赛季，结算回退不超过一段；新赛季前 5 场重新校准。

### 匹配算法
```text
输入：候选玩家集合 P，每位玩家拥有 (MMR, RD, RTT, 逃跑率, 地区)
步骤：
1. 按游戏和模式分桶，进入对应队列（Redis Sorted Set，以 MMR 为权重）。
2. 初始匹配窗口 = [MMR-100, MMR+100]。
3. 每 5 秒扩大窗口 ±50，直至上限 ±300。
4. 筛除 RTT > 200ms、逃跑率 > 阈值(5%) 的玩家；若人数不足触发托管机器人（仅休闲/单机模式）。
5. 采用 Hungarian 算法/最小化 |MMR_i - MMR_j| + RTT 加权，构造房间。
6. 匹配成功后写入 Redis session，派发 `match_found`，客户端确认后进入房间。
```
- **容错**：队列心跳 10s，断线保留 30s；取消匹配回收资源。
- **跨区**：优先同地区；当队列超过 30s 启用跨区（权重加入 RTT）。

### 输赢与积分
- **棋类游戏**：胜 +25~+35（随对手 MMR 漂移），负 -25~-35，和 ±5。超时/弃权额外 -10。
- **斗地主**：按倍数与角色换算成积分，再映射到 Glicko 更新；炸弹等倍数在胜负中体现。
- **德州扑克**：以盈利 BB 转换成胜率（盈利>0 视为胜），结合对手 MMR 更新。
- **逃跑惩罚**：
  - 排位：当局视为输 + 额外 -35；逃跑率>5% 降级匹配优先级。
  - 休闲：扣友好分（影响匹配权重），3 次以上禁止排位 24h。

---

## 经济体系与商业化
- **货币**：金币（游戏内获取）、钻石（付费/订阅）、赛季徽章。
- **商城**：皮肤、头像框、入场特效、表情、牌面主题、桌面主题；支持礼包、限时折扣、试用。
- **订阅**：月卡/季卡，提供去广告、专属 HUD、每周宝箱、赛季经验加成。
- **广告**：大厅 Banner、结算激励视频（非对局内）；需埋点 `ad_impression`、`ad_reward`。
- **经济平衡**：皮肤仅视觉，不影响胜率；赛季奖励 = 皮肤 + 货币。

---

## 社交、反作弊与风控
- **好友系统**：推荐（段位、最近对手）、搜索、邀请链接/二维码；好友上限 200。
- **聊天**：快捷短语 + 表情；自由文本走敏感词 + AI 审核；违规→禁言/限匹配。
- **观战**：好友观战延迟 5–10s，德州隐藏手牌；观战人数上限 20；房主可关闭。
- **反作弊**：
  - RNG：服务器 AES-CTR；RNG 种子写入命令日志。
  - 行为检测：操作频率、窗口焦点、鼠标轨迹、异常胜率。
  - 串谋检测：IP/GPS、长时同桌、让牌评分、下注相关性。
  - 风控评分：登录、支付、异常地理；触发二次验证。
- **仲裁流程**：举报 → 自动抽取回放 → 仲裁后台（渲染命令日志 + 状态快照）→ 处理结果通知。

---

## 数据模型与事件追踪
- **核心实体**：
  - `users`、`profiles`、`devices`、`sessions`（JWT/Refresh）。
  - `games`、`matches`、`rooms`、`game_sessions`（命令日志索引、RNG 种子）。
  - `ratings`、`leaderboards`、`achievements`、`tasks`。
  - `inventories`、`orders`、`subscriptions`、`ban_records`。
  - `telemetry_events`（ClickHouse，包含 event_name、user_id、props、ts）。
- **埋点事件**：`app_open`、`login_success`、`match_queue_start`、`match_found`、`room_join`、`turn_start`、`action_submit`、`action_ack`、`result_screen`、`replay_start`、`resume_success`、`store_purchase`、`rank_change`、`fps_bucket`、`ws_rtt`。
- **日志策略**：关键操作（登录、支付、风控）入审计日志；对局命令日志持久化 S3，并做哈希校验。
- **报表**：Grafana/Metabase 展示 KPI；Looker 或 Superset 供运营分析。

---

## 开发流程与交付阶段
> 阶段划分沿用原有 0-8 阶段体系，补充每阶段产物、验收与风险。

### Phase 0 — 基线与合规（Foundations）
- **范围**：代码仓库、CI/CD、环境配置；Telegram WebApp 登录与 JWT 会话；移动端适配规范；视觉主题基线；错误码字典。
- **产物**：`openapi.yaml`、`mobile-guidelines.md`、`error-codes.md`、`style-guide.md`。
- **验收**：真机自动登录成功；横竖屏切换 UI 正常；错误码友好提示。
- **风险**：密钥泄漏 → 秘钥轮换、加密存储、权限最小化。

### Phase 1 — PVP 垂直切片（五子棋）
- **范围**：大厅→匹配→房间→五子棋→结算→回放闭环；WebSocket 心跳、断线重连、幂等等；事件日志。
- **产物**：`/api/games`、`/api/match/start|cancel`、`/api/rooms`；WS `join_room/ready/play_action/...`；`engine-gomoku.md` 与实现；E2E 真机脚本。
- **验收**：双端真机完成对局；断网 10s 恢复；动作延迟 ≤ 200ms。
- **风险**：WS 不稳 → 指数退避、sinceSeq 同步、限流。

### Phase 2 — 多游戏接入
- **范围**：斗地主、德州扑克、象棋、国际象棋接入；大厅分类、搜索、最近游玩；房间人数适配。
- **产物**：`games/:id/meta`、各引擎文档与实现；HUD 与资源包。
- **验收**：四款游戏均可匹配、对战、回放；切换互不影响。
- **风险**：规则复杂 → 先 MVP 规则，逐步补完；资源体积 → 懒加载、分包。

### Phase 3 — 排行/任务/资料卡
- **范围**：段位、排行榜、资料卡、历史战绩、每日任务、成就、分享卡。
- **产物**：`/api/leaderboard`、`/api/profile/:id`、`/api/tasks/...`；评分异步更新。
- **验收**：段位变动即时展示；任务可领奖；分享卡渲染正确。
- **风险**：刷分 → 区间冷却、风控检测、回放复核。

### Phase 4 — 私密房/好友/观战
- **范围**：私密房、好友、观战、拉黑举报。
- **产物**：`/api/rooms`、`/api/friends`；WS 观战频道；权限模型。
- **验收**：非成员无法操作；观战延迟、带宽达标；拉黑生效。
- **风险**：观战滥用 → 延迟、速率限制、房主控制。

### Phase 5 — AI 陪练（可选）
- **范围**：局面分析、启发式提示、残局训练；练习模式不计分。
- **产物**：`/api/ai/suggest`；缓存策略；提示频率限制。
- **验收**：复杂局面给出稳定建议；练习与 PVP 隔离。
- **风险**：成本/延迟 → 小模型、缓存、断路器。

### Phase 6 — 反外挂/审计/观测
- **范围**：权威判定、帧序校验、异常指纹；审计回放；Observability。
- **产物**：`/internal/replay/:id`；指标埋点；OpenTelemetry。
- **验收**：指定对局可复原；异常可定位；SLO 达标。
- **风险**：高并发 → 匹配/房间拆分、Redis 分片。

### Phase 7 — 国际化/无障碍/运营后台
- **范围**：多语言、RTL、无障碍；运营后台配置。
- **产物**：i18n 资源、导入导出脚本；`/admin/tasks`、`/admin/banners`。
- **验收**：语言切换不刷新；后台配置热更新。
- **风险**：文案分散 → 统一管理；权限分层。

### Phase 8 — 变现与生态（可选）
- **范围**：付费皮肤、表情包、虚拟货币、赛事体系。
- **产物**：支付接口、虚拟货币结算、赛季活动配置。
- **验收**：购买/退款链路完整；活动提升留存。
- **风险**：合规 → 平台条款、地区法律审查。

---

## 测试、验收与质量保障
- **测试层级**：
  - 单元测试（Vitest/Jest）：规则引擎、匹配算法、排位计算、状态管理。
  - 属性测试：牌型组合、洗牌公平性、RNG 验证。
  - 集成/E2E：Playwright + 真机脚本覆盖大厅→匹配→对局→结算→回放→重连。
  - 性能测试：WS TPS、客户端帧率、首屏时间、资源下载；使用 Lighthouse、K6。
  - 安全测试：渗透、XSS/CSRF、重放攻击、风控绕过。
- **质量指标**：
  - 单测覆盖率 ≥ 80%；E2E 用例通过率 ≥ 95%。
  - 客户端崩溃率 ≤ 0.3%；长帧比 ≤ 1%。
  - 服务端错误率 ≤ 0.3%；匹配 p95 ≤ 10s。
- **验收表**：每个阶段产出对应验收项（功能、性能、无障碍、资源体积、监控、SLO）。

---

## 运维、发布与应急
- **CI/CD**：GitHub Actions/Drone；Lint + Test + Build + Bundle Analyzer；预生产灰度 10% → 25% → 100%。
- **发布策略**：蓝绿部署 + 金丝雀；版本号语义化；资源 CDN 哈希；强更/软更策略。
- **监控告警**：
  - 系统：CPU、内存、磁盘、WS 并发、Redis 命中、PG 慢查询。
  - 业务：匹配等待、逃跑率、排位波动、支付成功率、SW 安装成功率、缓存命中率。
  - 客户端：Sentry 崩溃、性能埋点、PWA 安装率。
- **Runbook**：扩容（手动/自动）、故障排查、回滚（上一稳定版镜像+资源）、仲裁流程、风控突发事件。
- **应急演练**：季度 Chaos Drill（网关宕机、Redis 故障、规则引擎异常）。

---

## 附录
### 术语
- **MMR**：Match Making Rating，匹配评分。
- **Glicko-2 参数**：µ（平均值）、φ（区间/不确定度）、σ（波动）。
- **RNG**：Random Number Generator，随机数生成器。
- **SLO/SLI/SLA**：服务目标/指标/协议。

### 配置模板
- **匹配扩圈**：`initial_window=100`、`step=50`、`max=300`、`interval=5s`。
- **步时限制**：五子棋 10s、象棋 10s、斗地主 20s、德州 20s。
- **离线缓存**：shell、gomoku 基础资源、公共 UI、最近访问游戏。

### 事件字典样例
| 事件 | 触发点 | 关键属性 |
| ---- | ------ | -------- |
| `match_queue_start` | 点击“开始匹配” | `game_id`, `mode`, `mmr`, `network_type` |
| `match_found` | 服务端推送 | `game_id`, `avg_mmr`, `latency`, `region` |
| `turn_start` | 对局轮次 | `game_id`, `player_id`, `turn_seq`, `remaining_time` |
| `result_screen` | 结算页展示 | `game_id`, `result`, `mmr_delta`, `rewards` |
| `escape_penalty` | 玩家逃跑 | `game_id`, `penalty_score`, `escape_rate` |

### 资源体积预算
- 大厅 JS gzip ≤ 180KB；单游戏首拉资源 ≤ 5MB；音频分包 ≤ 3MB。
- 粒子特效上限：高端 300 粒子、中端 150、低端 80。

### 参考素材清单
| 分类 | 需求数量 | 说明 |
| ---- | -------- | ---- |
| 大厅主题背景 | 4 | 曜金/晨光/极夜/节庆，1920×1080，含视差层 |
| 游戏桌面 | 4 | 对应四款游戏，含 1x/2x 版本 |
| 棋子/牌面 | 70+ | 五子棋 2 枚、象棋 32 枚、斗地主 54 张、德州筹码 6 面额 |
| HUD 图标 | 32 | 统一线性风格，24/32/48px |
| 表情包 | 16 | 动态/静态两套，可导出 JSON/Lottie |
| 空状态插画 | 8 | 匹配失败、无好友、离线、任务完成等 |

---

> 本文档需与 `openapi.yaml`、`asyncapi.yaml`、`style-guide.md`、`assets-manifest.json` 联动更新，任何跨团队影响的变更需发起 ADR 记录。
